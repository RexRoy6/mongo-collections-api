name: Deploy Laravel API to VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mongodb

    - name: Install dependencies
      run: |
        composer require mongodb/laravel-mongodb
        composer install --prefer-dist --no-ansi --no-interaction --no-progress --no-scripts --no-dev --optimize-autoloader

    - name: Deploy to VPS
      run: |
       mkdir -p ~/.ssh
       echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
       chmod 600 ~/.ssh/deploy_key
       ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

       ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
         ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'

         echo "Deploy user on VPS:"
         whoami

         cd /opt/api-mongo

         COMMIT_SHORT_SHA=${GITHUB_SHA:0:8}

         mkdir -p releases/${COMMIT_SHORT_SHA}
         cd releases/${COMMIT_SHORT_SHA}

         git clone https://github.com/${{ github.repository }} . --depth=1
         composer install --no-dev --optimize-autoloader --no-interaction

         mkdir -p bootstrap/cache
         mkdir -p storage/framework/views
         mkdir -p storage/framework/cache
         mkdir -p storage/framework/sessions
         mkdir -p storage/logs

         sudo chown -R www-data:www-data storage bootstrap/cache
         sudo chmod -R 775 storage bootstrap/cache

        ln -nfs ../../.env .env
        ln -nfs ../../storage/app storage/app
        ln -nfs ../../storage/framework storage/framework
        ln -nfs ../../storage/logs storage/logs

         cd /opt/api-mongo
         ln -nfs releases/${COMMIT_SHORT_SHA} current

         cd current
         php artisan optimize:clear
         php artisan config:cache
         php artisan route:cache
         php artisan view:cache
         php artisan optimize
         php artisan migrate

         sudo systemctl reload php8.2-fpm

         echo "âœ… Deploy finished"

        EOF
