name: Deploy Laravel API to VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mongodb

    - name: Install dependencies (CI only)
      run: |
        composer install --prefer-dist --no-dev --no-interaction --optimize-autoloader

    - name: Deploy to VPS
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
        ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
        set -e

        echo "Deploy user on VPS:"
        whoami

        cd /opt/api-mongo

        COMMIT_SHORT_SHA=${GITHUB_SHA:0:8}

        # Ensure clean release dir
        rm -rf releases/${COMMIT_SHORT_SHA}
        mkdir -p releases/${COMMIT_SHORT_SHA}
        cd releases/${COMMIT_SHORT_SHA}

        git clone https://github.com/${{ github.repository }} . --depth=1
        composer install --no-dev --optimize-autoloader --no-interaction

        mkdir -p bootstrap/cache
        mkdir -p storage/framework/views
        mkdir -p storage/framework/cache
        mkdir -p storage/framework/sessions
        mkdir -p storage/logs

        chmod -R 775 storage bootstrap/cache

        ln -nfs ../../.env .env
        ln -nfs ../../storage/app storage/app
        ln -nfs ../../storage/framework storage/framework
        ln -nfs ../../storage/logs storage/logs

        cd /opt/api-mongo
        if [ ! -d "releases/${COMMIT_SHORT_SHA}" ]; then
          echo "❌ Release directory missing"
          exit 1
        fi

        ln -nfs releases/${COMMIT_SHORT_SHA} current

        cd current
        php artisan optimize:clear
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache
        php artisan optimize
        php artisan migrate --force

        sudo systemctl reload php8.2-fpm

        echo "✅ Deploy finished"
        EOF
